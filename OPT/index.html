<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ONE PIECE OF TIME Alpha</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-neutral-950 text-neutral-100">
  <div class="max-w-3xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">ONE PIECE OF TIME</h1>
      <button id="loginBtn" class="px-3 py-1 rounded bg-indigo-600">Entrar con Google</button>
    </header>

    <section class="space-y-3">
      <label class="block text-sm">Elige una fecha</label>
      <input id="dateInput" type="date" class="w-full bg-neutral-900 border border-neutral-700 rounded p-2" />
      <input id="textInput" placeholder="o escribe YYYY-MM-DD (acepta 0001-01-01)" class="w-full bg-neutral-900 border border-neutral-700 rounded p-2" />
      <button id="checkBtn" class="px-4 py-2 bg-emerald-600 rounded">Consultar / Reclamar</button>
      <div id="result" class="mt-4 text-sm"></div>
    </section>
  </div>

  <script>
    // Tu proyecto Supabase
    const supabase = window.supabase.createClient(
      'https://vvhejqhiceuillazlwlp.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2aGVqcWhpY2V1aWxsYXpsd2xwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0OTAzOTMsImV4cCI6MjA3NzA2NjM5M30.deBKXONBB8goQVY61Fy75pTi-iNWjlKIXkbeJBW0aj8' // <-- pega aquí tu anon key (de Project Settings → API)
    );

    // Login con Google
    document.getElementById('loginBtn').onclick = async () => {
      const { error } = await supabase.auth.signInWithOAuth({ provider: 'google' });
      if (error) alert(error.message);
    };

    // Buscar o reclamar fecha
    document.getElementById('checkBtn').onclick = async () => {
      const dateVal = document.getElementById('dateInput').value;
      const textVal = document.getElementById('textInput').value.trim();
      const day = textVal || dateVal;
      if (!day) return alert('Selecciona o escribe una fecha');

      const { data: dateRow, error: upErr } = await supabase
        .from('dates')
        .upsert({ day }, { onConflict: 'day' })
        .select('*')
        .single();
      if (upErr) return alert(upErr.message);

      if (dateRow.is_claimed) {
        document.getElementById('result').innerHTML = `<span class="text-red-400">Fecha reclamada</span>`;
        return;
      }

      document.getElementById('result').innerHTML = `
        <div class="space-y-2">
          <div>Disponible. Precio base MVP: <b>$1</b></div>
          <input id="ownerTitle" placeholder="Título del dueño (opcional)" class="w-full bg-neutral-900 border border-neutral-700 rounded p-2" />
          <button id="claim" class="px-3 py-1 rounded bg-emerald-700">Reclamar ahora</button>
        </div>`;

      document.getElementById('claim').onclick = async () => {
        const session = (await supabase.auth.getSession()).data.session;
        if (!session) return alert('Inicia sesión primero');

        const owner_title = document.getElementById('ownerTitle').value;

        const resp = await fetch('https://vvhejqhiceuillazlwlp.supabase.co/functions/v1/claim_date', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${session.access_token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ day, owner_title })
        });

        const json = await resp.json();
        if (json.ok) {
          document.getElementById('result').innerHTML = `<span class="text-emerald-400">¡Reclamada!</span>`;
        } else {
          alert(JSON.stringify(json));
        }
      };
    };
  </script>
</body>
</html>
